<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>PDF → OpenAI (OKR) – Demo</title>
  <script src="https://miro.com/app/static/sdk/v2/miro.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; font-size: 13px; margin: 0; padding: 10px; color: #111827; }
    h1 { font-size: 16px; margin: 0 0 10px 0; }
    label { font-weight: 600; display:block; margin-top: 8px; }
    input, textarea, select { width: 100%; box-sizing: border-box; margin-top: 4px; padding: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; }
    textarea { min-height: 140px; resize: vertical; }
    button { margin-top: 10px; padding: 8px 10px; font-size: 12px; border-radius: 6px; border: 1px solid #d1d5db; background: #f3f4f6; cursor: pointer; }
    button:hover { background: #e5e7eb; }
    #log { margin-top: 10px; height: 240px; overflow:auto; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 11px; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px; background: #f9fafb; }
  </style>
</head>
<body>
  <h1>PDF → OpenAI (OKR) – Demo</h1>

  <label for="backendUrl">Backend URL (Vercel)</label>
  <input id="backendUrl" type="text" placeholder="https://dein-projekt.vercel.app" />

  <label for="openaiKey">OpenAI API Key</label>
  <input id="openaiKey" type="password" placeholder="sk-..." />

  <label for="model">Modell</label>
  <select id="model">
    <option value="gpt-5.2">gpt-5.2</option>
  </select>

  <label for="prompt">Prompt (OKR Analyse)</label>
  <textarea id="prompt">ROLE
You are a senior strategy-to-execution consultant and OKR architect.

TASK
Given an attached Corporate Strategy document (usually a PDF with text + charts), you must:
1) Read the entire document (including tables, exhibits, charts, appendices, disclaimers).
2) Extract and model the strategy logic (context → choices → capabilities → financial/resource commitments).
3) Produce a high-quality OKR catalog (Objectives & Key Results) that is traceable to the document.

NON-NEGOTIABLE RULES
- Do NOT invent facts, numbers, dates, or commitments that are not supported by the document.
- Every Objective and every Key Result MUST include:
  a) Source page(s)
  b) A short evidence snippet (<= 20 words, paraphrase preferred; if quoting, keep it short)
  c) A label: {EXPLICIT} if directly stated, {INFERRED/OPERATIONALIZED} if you created a measurable proxy.
- If a critical metric is missing, create a measurable proxy KR but mark it {INFERRED/OPERATIONALIZED}.
- Do not ask the user questions; proceed with best-effort assumptions and clearly list assumptions.

STEP 1 — STRATEGY EXTRACTION (OUTPUT IN BULLETS)
A) Document meta:
   - Company name, strategy name, publication date
   - Strategy time horizon (years/fiscal years) and definitions (e.g., FY ends when?)
B) Strategic context / diagnosis:
   - External environment shifts, risks, disruptions, megatrends
C) Strategic intent:
   - Vision / north star
   - Value creation logic (pillars, themes, strategic framework)
D) Quantitative targets and commitments:
   - Financial targets (e.g., ROE, margin, cash flow, growth rates)
   - Capital allocation, investment/divestment plans, shareholder return policy
E) Strategic initiatives & programs:
   - Major programs (e.g., “Transform”, “Digital”, “Energy Transition”, “AI”, “M&A”)
   - Enablers (talent, operating model, governance, partnerships)
F) Constraints and guardrails:
   - Financial soundness constraints (e.g., leverage, ratings)
   - Risk/compliance/ESG principles mentioned
G) Disclaimers:
   - Forward-looking statement limitations (note for OKR risk management)

STEP 2 — OKR DESIGN PRINCIPLES (INTERNAL)
Apply these:
- 5–9 Corporate-level Objectives max, each with 3–5 Key Results.
- Objectives: qualitative, outcome-oriented, direction-setting (not a metric).
- Key Results: measurable outcomes (numbers or verifiable states), time-bound to the strategy horizon.
- Ensure coverage:
  (1) Growth outcomes, (2) Efficiency/capital productivity, (3) Portfolio/capital allocation,
  (4) Core-business strengthening, (5) New growth creation, (6) Capabilities (talent/AI/ops model),
  (7) Shareholder returns and financial guardrails (if in doc).
- Avoid duplicates: each KR should measure a distinct outcome.

STEP 3 — OUTPUT: OKR CATALOG (TWO FORMATS)

FORMAT A — HUMAN READABLE (MARKDOWN)
For each Objective:
- Objective title
- Intent (1–2 sentences)
- Key Results (3–5 items), each with:
  * Metric / Definition
  * Baseline (if stated)
  * Target (explicit number/date if stated)
  * Due date / time horizon
  * Evidence: page(s) + snippet
  * Tag: {EXPLICIT} or {INFERRED/OPERATIONALIZED}

FORMAT B — MACHINE READABLE (JSON)
Return a JSON array with this schema:
[
  {
    "objective_id": "O1",
    "objective": "...",
    "time_horizon": "...",
    "intent": "...",
    "source_pages": [..],
    "key_results": [
      {
        "kr_id": "KR1",
        "metric": "...",
        "baseline": "... or null",
        "target": "...",
        "due": "...",
        "type": "EXPLICIT | INFERRED/OPERATIONALIZED",
        "evidence": {
          "pages": [..],
          "snippet": "..."
        },
        "notes": "assumptions or operationalization details"
      }
    ]
  }
]

STEP 4 — QUALITY CHECK (MANDATORY)
Before finalizing, run these checks and report results:
- Coverage check: Did you include every major quantitative target as at least one KR?
- Traceability check: Does every Objective + KR have page(s) and evidence snippet?
- Non-hallucination check: Are all numbers/dates sourced?
- OKR hygiene: Objectives not phrased as metrics; KRs measurable; 3–5 KRs per objective.

FINAL OUTPUT ORDER
1) Strategy extraction bullets (Step 1)
2) OKR catalog in Markdown (Format A)
3) OKR catalog in JSON (Format B)
4) Quality check results (Step 4).</textarea>

  <button id="btnRun">Analyze selected PDF → OKR</button>

  <div id="log"></div>

  <script>
    function log(msg) {
      const el = document.getElementById("log");
      const t = (typeof msg === "string") ? msg : JSON.stringify(msg, null, 2);
      el.textContent = (el.textContent ? el.textContent + "\n\n" : "") + t;
      el.scrollTop = el.scrollHeight;
    }

    async function ensureMiroReady() {
      return new Promise((resolve) => {
        const onReady = () => resolve();
        if (window.miro && window.miro.board) return onReady();
        if (window.miro && typeof window.miro.onReady === "function") return window.miro.onReady(onReady);
        return onReady();
      });
    }

    function normalizeBaseUrl(url) {
      const u = (url || "").trim();
      if (!u) return "";
      return u.endsWith("/") ? u.slice(0, -1) : u;
    }

    async function run() {
      await ensureMiroReady();

      const backendUrl = normalizeBaseUrl(document.getElementById("backendUrl").value);
      const openaiKey = document.getElementById("openaiKey").value.trim();
      const model = document.getElementById("model").value;
      const prompt = document.getElementById("prompt").value.trim();

      if (!backendUrl) { log("Fehler: Backend URL fehlt."); return; }
      if (!openaiKey) { log("Fehler: OpenAI API Key fehlt."); return; }

      // Board-ID holen (Web SDK v2: board.getInfo())
      let boardInfo;
      try {
        boardInfo = await miro.board.getInfo();
      } catch (e) {
        log("Fehler: miro.board.getInfo() fehlgeschlagen: " + e.message);
        return;
      }
      const boardId = boardInfo && boardInfo.id ? boardInfo.id : null;
      if (!boardId) { log("Fehler: Keine boardId gefunden."); return; }

      // Selektion holen (du musst GENAU 1 PDF anklicken)
      let selection;
      try {
        selection = await miro.board.getSelection();
      } catch (e) {
        log("Fehler: miro.board.getSelection() fehlgeschlagen: " + e.message);
        return;
      }

      if (!Array.isArray(selection) || selection.length !== 1) {
        log("Bitte genau 1 Item auswählen (das PDF). Aktuelle Auswahl: " + (selection ? selection.length : 0));
        return;
      }

      const item = selection[0];
      if (!item || !item.id) {
        log("Fehler: Auswahl hat keine Item-ID.");
        return;
      }

      // PDFs sind im Web SDK v2 typischerweise 'unsupported' – aber die ID reicht.
      const itemId = item.id;

      const payload = {
        boardId,
        itemId,
        openaiKey,
        model,
        prompt
      };

      log("Request → Backend:\n" + JSON.stringify({ boardId, itemId, model, itemType: item.type || "unknown" }, null, 2));

      try {
        const res = await fetch(backendUrl + "/api/analyze-selected-pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        if (!res.ok) {
          log("Backend Fehler " + res.status + ":\n" + text);
          return;
        }

        const data = JSON.parse(text);
        log("OK. Backend Response:");
        log(data);

        // Optional: Ergebnis direkt als Text-Item auf Board schreiben, falls Backend kein Doc erstellt hat
        if (data && data.answer && !data.createdDocId) {
          try {
            const createdText = await miro.board.createText({
              content: "<p><strong>OKR-Analyse (Fallback Text)</strong></p><p>" + String(data.answer).replaceAll("\n", "<br/>") + "</p>",
              x: 0,
              y: 0
            });
            log("Fallback: Text-Item erstellt: " + (createdText && createdText.id ? createdText.id : "(keine id)"));
          } catch (eTxt) {
            log("Fallback: Konnte Text-Item nicht erstellen: " + eTxt.message);
          }
        }

      } catch (e) {
        log("Exception beim Backend Call: " + e.message);
      }
    }

    document.getElementById("btnRun").addEventListener("click", run);
    log("Panel geladen.\n1) PDF auf dem Board anklicken (genau 1 Item).\n2) Backend URL + OpenAI Key eintragen.\n3) Button drücken.");
  </script>
</body>
</html>

